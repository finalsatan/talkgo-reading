### 案例篇：服务吞吐量下降很厉害，怎么分析？

1. 概念

> 



2. 涉及到的命令

```shell
# 默认测试时间为10s，请求超时2s
$ wrk --latency -c 1000 http://192.168.0.30

# 查看 TCP 连接数
$ ss -s

# 运行下面的命令，查看系统日志
$ dmesg | tail

# 将连接跟踪限制增大到1048576
$ sysctl -w net.netfilter.nf_conntrack_max=1048576
```

3. 结论

> 实际上，分析性能瓶颈，最核心的也正是掌握运用这些原理。
>
> - 首先，利用各种性能工具，收集想要的性能指标，从而清楚系统和应用程序的运行状态；
> - 其次，拿目前状态跟系统原理进行比较，不一致的地方，就是我们要重点分析的对象。

### 套路篇：系统监控的综合思路

1. 概念

> 一个好的监控系统，不仅可以实时暴露系统的各种问题，更可以根据这些监控到的状态，自动分析和定位大致的瓶颈来源，从而更精确地把问题汇报给相关团队处理。
>
> - 使用率，表示资源用于服务的时间或容量百分比。100% 的使用率，表示容量已经用尽或者全部时间都用于服务。
> - 饱和度，表示资源的繁忙程度，通常与等待队列的长度相关。100% 的饱和度，表示资源无法接受更多的请求。
> - 错误数表示发生错误的事件个数。错误数越多，表明系统的问题越严重。

![系统监控指标分类](./img/系统监控指标分类.png)



2. 涉及到的命令

```shell

```

3. 结论

> 系统监控的核心是资源的使用情况，包括 CPU、内存、磁盘和文件系统、网络等硬件资源，以及文件描述符数、连接数、连接跟踪数等软件资源。而这些资源，都可以通过 USE 法来建立核心性能指标。

### 套路篇：应用监控的一般思路

1. 概念

> 应用程序的核心指标，不再是资源的使用情况，而是请求数、错误率和响应时间。
>
> - 第一个，是应用进程的资源使用情况，比如进程占用的 CPU、内存、磁盘 I/O、网络等。使用过多的系统资源，导致应用程序响应缓慢或者错误数升高，是一个最常见的性能问题。
> - 第二个，是应用程序之间调用情况，比如调用频率、错误数、延时等。由于应用程序并不是孤立的，如果其依赖的其他应用出现了性能问题，应用自身性能也会受到影响。
> - 第三个，是应用程序内部核心逻辑的运行情况，比如关键环节的耗时以及执行过程中的错误等。由于这是应用程序内部的状态，从外部通常无法直接获取到详细的性能数据。所以，应用程序在设计和开发时，就应该把这些指标提供出来，以便监控系统可以了解其内部运行状态。
>
> 对日志监控来说，最经典的方法，就是使用 ELK 技术栈，即使用 Elasticsearch、Logstash 和 Kibana 这三个组件的组合。



2. 涉及到的命令

```shell

```

3. 结论

> 应用程序的监控，可以分为指标监控和日志监控两大部分：
>
> - 指标监控主要是对一定时间段内性能指标进行测量，然后再通过时间序列的方式，进行处理、存储和告警。
> - 日志监控则可以提供更详细的上下文信息，通常通过 ELK 技术栈来进行收集、索引和图形化展示。

### 套路篇：分析性能问题的一般步骤

1. 概念

> 应用程序性能问题虽然各种各样，但就其本质来源，实际上只有三种，也就是资源瓶颈、依赖服务瓶颈以及应用自身的瓶颈。
>
> - 第一种资源瓶颈，其实还是指刚才提到的 CPU、内存、磁盘和文件系统 I/O、网络以及内核资源等各类软硬件资源出现了瓶颈，从而导致应用程序的运行受限。对于这种情况，我们就可以用前面系统资源瓶颈模块提到的各种方法来分析。
> - 第二种依赖服务的瓶颈，也就是诸如数据库、分布式缓存、中间件等应用程序，直接或者间接调用的服务出现了性能问题，从而导致应用程序的响应变慢，或者错误率升高。这说白了就是跨应用的性能问题，使用全链路跟踪系统，就可以帮你快速定位这类问题的根源。
> - 最后一种，应用程序自身的性能问题，包括了多线程处理不当、死锁、业务算法的复杂度过高等等。对于这类问题，在我们前面讲过的应用程序指标监控以及日志监控中，观察关键环节的耗时和内部执行过程中的错误，就可以帮你缩小问题的范围。



2. 涉及到的命令

```shell

```

3. 结论

> 虽然瓶颈分为了系统和应用两个角度，但在实际运行时，这两者往往是相辅相成、相互影响的。
>
> 系统是应用的运行环境，系统的瓶颈会导致应用的性能下降；而应用的不合理设计，也会引发系统资源的瓶颈。

### 套路篇：优化性能问题的一般方法

1. 概念

> CPU 性能优化的核心，在于排除所有不必要的工作、充分利用 CPU 缓存并减少进程调度对性能的影响。
>
> 内存性能的优化可以通过以下几种方法：
>
> - 第一种，除非有必要，Swap 应该禁止掉。这样就可以避免 Swap 的额外 I/O ，带来内存访问变慢的问题。
> - 第二种，使用 Cgroups 等方法，为进程设置内存限制。这样就可以避免个别进程消耗过多内存，而影响了其他进程。对于核心应用，还应该降低 oom_score，避免被 OOM 杀死。
> - 第三种，使用大页、内存池等方法，减少内存的动态分配，从而减少缺页异常。
>
> 优化磁盘和文件系统I/O，有三种最典型的方法：
>
> - 第一种，也是最简单的方法，通过 SSD 替代 HDD、或者使用 RAID 等方法，提升 I/O 性能。
> - 第二种，针对磁盘和应用程序 I/O 模式的特征，选择最适合的 I/O 调度算法。比如，SSD 和虚拟机中的磁盘，通常用的是 noop 调度算法；而数据库应用，更推荐使用 deadline 算法。
> - 第三种，优化文件系统和磁盘的缓存、缓冲区，比如优化脏页的刷新频率、脏页限额，以及内核回收目录项缓存和索引节点缓存的倾向等等。
>
> 网络性能的优化有以下几种典型方法：
>
> - 首先，从内核资源和网络协议的角度来说，我们可以对内核选项进行优化。
> - 其次，从网络接口的角度来说，我们可以考虑对网络接口的功能进行优化。
> - 最后，在极限性能情况（比如 C10M）下，内核的网络协议栈可能是最主要的性能瓶颈，所以，一般会考虑绕过内核协议栈。
>
> 应用程序的优化有以下几种方法：
>
> - 第一，从 CPU 使用的角度来说，简化代码、优化算法、异步处理以及编译器优化等，都是常用的降低 CPU 使用率的方法，这样可以利用有限的 CPU 处理更多的请求。
> - 第二，从数据访问的角度来说，使用缓存、写时复制、增加 I/O 尺寸等，都是常用的减少磁盘 I/O 的方法，这样可以获得更快的数据处理速度。
> - 第三，从内存管理的角度来说，使用大页、内存池等方法，可以预先分配内存，减少内存的动态分配，从而更好地内存访问性能。
> - 第四，从网络的角度来说，使用 I/O 多路复用、长连接代替短连接、DNS 缓存等方法，可以优化网络 I/O 并减少网络请求数，从而减少网络延时带来的性能问题。
> - 第五，从进程的工作模型来说，异步处理、多线程或多进程等，可以充分利用每一个 CPU 的处理能力，从而提高应用程序的吞吐能力。



2. 涉及到的命令

```shell

```

3. 结论

> 虽然性能优化的方法很多，不过，我还是那句话，一定要避免过早优化。性能优化往往会提高复杂性，这一方面降低了可维护性，另一方面也为适应复杂多变的新需求带来障碍。
>
> 所以，性能优化最好是逐步完善，动态进行；不追求一步到位，而要首先保证，能满足当前的性能要求。发现性能不满足要求或者出现性能瓶颈后，再根据性能分析的结果，选择最重要的性能问题进行优化。

### 套路篇：Linux 性能工具速查

1. 概念

> 



2. 涉及到的命令

```shell

```

3. 结论

> 当分析性能问题时，大的来说，主要有这么两个步骤：
>
> - 第一步，从性能瓶颈出发，根据系统和应用程序的运行原理，确认待分析的性能指标。
> - 第二步，根据这些图表，选出最合适的性能工具，然后了解并使用工具，从而更快观测到需要的性能数据。
>
> 性能工具不是性能分析和优化的全部。
>
> - 一方面，性能分析和优化的核心，是对系统和应用程序运行原理的掌握，而性能工具只是辅助你更快完成这个过程的帮手。
> - 另一方面，完善的监控系统，可以提供绝大部分性能分析所需的基准数据。从这些数据中，你很可能就能大致定位出性能瓶颈，也就不用再去手动执行各类工具了。

### 答疑（六）：容器冷启动如何性能分析？

1. 概念

> **CPU 火焰图和内存火焰图，最大的差别其实就是数据来源的不同**，也就是函数堆栈不同，而火焰图的格式还是完全一样的。
>
> - 对 CPU 火焰图来说，采集的数据主要是消耗 CPU 的函数；
> - 而对内存火焰图来说，采集的数据主要是内存分配、释放、换页等内存管理函数。
>
> **RED 方法**，是 Weave Cloud 在监控微服务性能时，结合 Prometheus 监控，所提出的一种监控思路——即对微服务来说，监控它们的请求数（Rate）、错误数（Errors）以及响应时间（Duration）。所以，RED 方法适用于微服务应用的监控，而 USE 方法适用于系统资源的监控。



2. 涉及到的命令

```shell

```

3. 结论







